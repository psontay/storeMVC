<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>StoreMVC - Quản lý Người dùng</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/user-management.css}">
</head>
<body>
<div class="layout" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <div class="logo">SM</div>
            <div class="brand-text">StoreMVC</div>
        </div>
        <nav class="nav">
            <div class="nav-section">Quản lý</div>
            <a class="nav-item" th:href="@{/admin/dashboard}"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
            <a class="nav-item" th:href="@{/admin/users}"><i class="bi bi-people-fill"></i><span>Người dùng</span></a>
            <a class="nav-item" th:href="@{/admin/products}"><i class="bi bi-box-seam"></i><span>Sản phẩm</span></a>
            <a class="nav-item" th:href="@{/admin/categories}"><i class="bi bi-tags-fill"></i><span>Danh mục</span></a>
            <a class="nav-item active" th:href="@{/admin/orders}"><i class="bi bi-receipt"></i><span>Đơn hàng</span></a>
        </nav>
        <div class="sidebar-footer">
            <button id="collapseBtn" class="btn small">Thu nhỏ</button>
            <label class="switch">
                <input id="themeToggle" type="checkbox">
                <span class="slider"></span>
            </label>
        </div>
    </aside>

    <main class="main">
        <header class="topbar">
            <div class="left">
                <button id="toggleSidebar" class="icon-btn">☰</button>
                <form th:action="@{/admin/users/search}" method="get" style="display:inline;">
                    <input id="searchUserInput" class="search" name="search" placeholder="Find user..." th:value="${param.search}" />
                </form>
            </div>
        </header>

        <section class="content">
            <div class="actions">
                <button type="button" class="btn" id="createUserBtn">Create user</button>
            </div>

            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <!-- CREATE FORM -->
            <div id="createUserFormCard" style="display:none;">
                <form id="createForm" th:action="@{/admin/users/create}" method="post" class="form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <h3>Create user</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input name="username" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input name="password" type="password" required>
                    </div>
                    <div class="form-group">
                        <label>Họ tên</label>
                        <input name="fullName" type="text">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input name="email" type="email" required>
                    </div>
                    <div class="form-group">
                        <label>Số điện thoại</label>
                        <input name="telPhone" type="text">
                    </div>
                    <div class="form-group">
                        <label>Địa chỉ</label>
                        <input name="address" type="text">
                    </div>
                    <div class="form-group">
                        <label>Vai trò</label>
                        <select name="roles" multiple size="3">
                            <option value="USER">USER</option>
                            <option value="ADMIN">ADMIN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Permissions:</label>
                        <div class="checkbox-group" th:each="p : ${permissions}">
                            <label>
                                <input type="checkbox" name="permissions" th:value="${p}">
                                <span th:text="${p}"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Save</button>
                        <button type="button" class="btn danger cancelBtn">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- EDIT FORM -->
            <div id="editUserFormCard" th:if="${editUserId != null}" >
                <form id="editForm" th:action="@{/admin/users/{username}/update(username=${editUserId})}" method="post" class="form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <h3>Edit user</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input name="username" type="text" th:value="${editUser.username}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input name="password" type="password" th:value="${editUser.password}" required>
                    </div>
                    <div class="form-group">
                        <label>Họ tên</label>
                        <input name="fullName" type="text" th:value="${editUser.fullName}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input name="email" type="email" th:value="${editUser.email}">
                    </div>
                    <div class="form-group">
                        <label>Số điện thoại</label>
                        <input name="telPhone" type="text" th:value="${editUser.telPhone}">
                    </div>
                    <div class="form-group">
                        <label>Địa chỉ</label>
                        <input name="address" type="text" th:value="${editUser.address}">
                    </div>
                    <div class="form-group">
                        <label>Vai trò</label>
                        <select name="roles" multiple size="3">
                            <option value="USER" th:selected="${editUser.roles.contains('USER')}">USER</option>
                            <option value="ADMIN" th:selected="${editUser.roles.contains('ADMIN')}">ADMIN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Permissions</label>
                        <div th:each="p : ${permissions}">
                            <label>
                                <input type="checkbox" name="permissions" th:value="${p}" th:checked="${editUser.permissions.contains(p)}">
                                <span th:text="${p}"></span>
                            </label><br/>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Save changes</button>
                        <button type="button" class="btn danger cancelBtn" onclick="window.location.href='/admin/users'">Cancel edit</button>
                    </div>
                </form>
            </div>

            <!-- USER TABLE -->
            <div class="card table-card">
                <h3>Danh sách người dùng</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Tên người dùng</th>
                            <th>Email</th>
                            <th>Vai trò</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user, iterStat : ${userPage.content}">
                            <td th:text="${iterStat.index + 1 + (currentPage * pageSize)}"></td>
                            <td th:text="${user.username}"></td>
                            <td th:text="${user.email}"></td>
                            <td th:text="${#strings.arrayJoin(user.roles.toArray(), ', ')}"></td>
                            <td>
                                <a th:href="@{/admin/users/{username}/edit(username=${user.username})}" class="btn small">Sửa</a>

                                <form th:action="@{/admin/users/{username}/delete(username=${user.username})}" method="post" style="display:inline">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn small danger" onclick="return confirm('Bạn có chắc muốn xóa?')">Xóa</button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <a th:if="${!userPage.first}" th:href="@{/admin/users(page=${currentPage - 1}, size=${pageSize})}">« Prev</a>
                        <span>Page <span th:text="${currentPage + 1}"></span> / <span th:text="${userPage.totalPages}"></span></span>
                        <a th:if="${!userPage.last}" th:href="@{/admin/users(page=${currentPage + 1}, size=${pageSize})}">Next »</a>
                    </div>
                </div>
            </div>

        </section>
    </main>
</div>

<script th:src="@{/js/user-management.js}" defer></script>
<script th:src="@{/js/theme.js}" defer></script>

</body>
</html>
