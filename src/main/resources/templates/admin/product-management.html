<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>StoreMVC - Quản lý Sản phẩm</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/product-management.css}">
</head>
<body>
<div class="layout" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <div class="logo">SM</div>
            <div class="brand-text">StoreMVC</div>
        </div>
        <nav class="nav">
            <div class="nav-section">Quản lý</div>
            <a class="nav-item" th:href="@{/admin/dashboard}"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
            <a class="nav-item" th:href="@{/admin/users}"><i class="bi bi-people-fill"></i><span>Người dùng</span></a>
            <a class="nav-item" th:href="@{/admin/products}"><i class="bi bi-box-seam"></i><span>Sản phẩm</span></a>
            <a class="nav-item" th:href="@{/admin/categories}"><i class="bi bi-tags-fill"></i><span>Danh mục</span></a>
            <a class="nav-item active" th:href="@{/admin/orders}"><i class="bi bi-receipt"></i><span>Đơn hàng</span></a>
        </nav>
        <div class="sidebar-footer">
            <button id="collapseBtn" class="btn small">Thu nhỏ</button>
            <label class="switch">
                <input id="themeToggle" type="checkbox">
                <span class="slider"></span>
            </label>
        </div>
    </aside>

    <main class="main">
        <header class="topbar">
            <div class="left">
                <button id="toggleSidebar" class="icon-btn">Menu</button>
                <form th:action="@{/admin/products}" method="get" style="display:inline;">
                    <input class="search" name="name" placeholder="Tìm sản phẩm..." th:value="${param.name}"/>
                </form>
            </div>
            <div class="right">
                <span th:text="${#authentication.name}">Admin</span>
            </div>
        </header>

        <section class="content">

            <!-- Thông báo -->
            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <div class="actions">
                <button type="button" class="btn primary" id="createProductBtn">
                    <i class="bi bi-plus-lg"></i> Thêm sản phẩm mới
                </button>
            </div>

            <!-- FORM TẠO MỚI -->
            <div id="createProductCard" class="card" style="display:none;">
                <form th:action="@{/admin/products/create}" method="post" class="form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <h3>Thêm sản phẩm mới</h3>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tên sản phẩm <span class="req">*</span></label>
                            <input name="name" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>Mô tả</label>
                            <textarea name="description" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Giá bán (₫) <span class="req">*</span></label>
                            <input name="price" type="number" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Số lượng tồn</label>
                            <input name="stockQuantity" type="number" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Link ảnh</label>
                        <input name="imageUrl" type="url" placeholder="https://example.com/image.jpg">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Danh mục <span class="req">*</span></label>
                            <select name="categoryId" multiple size="5" required>
                                <option th:each="cat : ${categories}"
                                        th:value="${cat.id}"
                                        th:text="${cat.name}"
                                        th:selected="${editProduct != null && editProduct.categoryIds != null && editProduct.categoryIds.contains(cat.id)}">
                                </option>
                            </select>
                            <small>Giữ <kbd>Ctrl</kbd> để chọn nhiều</small>
                        </div>
                        <div class="form-group">
                            <label>Nhà cung cấp <span class="req">*</span></label>
                            <select name="supplierId" required>
                                <option value="">-- Chọn nhà cung cấp --</option>
                                <option th:each="sup : ${suppliers}"
                                        th:value="${sup.id}"
                                        th:text="${sup.name + ' (' + sup.telPhone + ')'}"
                                        th:selected="${editProduct != null && editProduct.supplierId != null && sup.id == editProduct.supplierId}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn primary">Lưu sản phẩm</button>
                        <button type="button" class="btn cancelBtn">Hủy</button>
                    </div>
                </form>
            </div>

            <!-- FORM SỬA (chỉ hiện khi có editProduct) -->
            <div id="editProductCard" th:if="${editProduct != null}" class="card">
                <form th:action="@{'/admin/products/edit/' + ${editProduct.id}}" method="post" class="form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <h3>Chỉnh sửa sản phẩm</h3>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tên sản phẩm</label>
                            <input name="name" type="text" th:value="${editProduct.name}" required>
                        </div>
                        <div class="form-group">
                            <label>Mô tả</label>
                            <textarea name="description" rows="3" th:text="${editProduct.description}"></textarea>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Giá bán (₫)</label>
                            <input name="price" type="number" th:value="${editProduct.price}" required>
                        </div>
                        <div class="form-group">
                            <label>Số lượng tồn</label>
                            <input name="stockQuantity" type="number" th:value="${editProduct.stockQuantity}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Link ảnh</label>
                        <input name="imageUrl" type="url" th:value="${editProduct.imageUrl}">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Danh mục</label>
                            <select name="categoryId" multiple size="5">
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}" th:selected="${editProduct.categoryIds != null && editProduct.categoryIds.contains(cat.id)}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nhà cung cấp</label>
                            <select name="supplierId">
                                <option th:each="sup : ${suppliers}"
                                        th:value="${sup.id}"
                                        th:text="${sup.name}"
                                        th:selected="${sup.id == editProduct.supplierId}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn primary">Cập nhật</button>
                        <button type="button" class="btn" onclick="window.location.href='/admin/products'">Hủy</button>
                    </div>
                </form>
            </div>

            <!-- BẢNG SẢN PHẨM -->
            <div class="card table-card">
                <h3>Danh sách sản phẩm (<span th:text="${page.totalElements}">0</span>)</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá</th>
                            <th>Kho</th>
                            <th>Nhà cung cấp</th>
                            <th>Danh muc</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="p, iter : ${page.content}">
                            <td th:text="${iter.index + 1 + (page.number * page.size)}"></td>
                            <td>
                                <img th:src="${p.imageUrl} ?: 'https://via.placeholder.com/50'"
                                     width="50" height="50" style="object-fit:cover;border-radius:4px;">
                            </td>
                            <td>
                                <div th:text="${p.name}"></div>
                                <small class="text-muted" th:text="${#strings.abbreviate(p.description, 40)}"></small>
                            </td>
                            <td th:text="${#numbers.formatInteger(p.price, 0, 'COMMA') + ' ₫'}"></td>
                            <td th:text="${p.stockQuantity}"></td>
                            <td th:text="${p.supplierName}">?</td>
                            <td th:text="${#strings.listJoin(p.categoryNames, ', ')}">?</td>                            <td>
                                <a th:href="@{'/admin/products/edit/' + ${p.id}}" class="btn small">Sửa</a>
                                <form th:action="@{'/admin/products/delete/' + ${p.id}}" method="post"
                                      style="display:inline" onsubmit="return confirm('Xóa sản phẩm này?')">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button type="submit" class="btn small danger">Xóa</button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- Phân trang -->
                    <div class="pagination">
                        <a th:if="${!page.first}"
                           th:href="@{/admin/products(page=${page.number - 1}, size=${page.size}, name=${param.name})}">« Trước</a>
                        <span>Trang <strong th:text="${page.number + 1}"></strong> / <span th:text="${page.totalPages}"></span></span>
                        <a th:if="${!page.last}"
                           th:href="@{/admin/products(page=${page.number + 1}, size=${page.size}, name=${param.name})}">Sau »</a>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script th:src="@{/js/product-management.js}" defer></script>
<script th:src="@{/js/theme.js}" defer></script>
</body>
</html>